<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>AiWinLab</title>
  <style>
    /* Стили как у тебя — без изменений */
    body {
      font-family: 'Verdana', sans-serif;
      margin: 0;
      padding: 10px;
      background: #000000;
      color: #000000;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    .header {
      width: 100%;
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding: 10px;
      box-sizing: border-box;
    }
    .logo {
      display: flex;
      flex-direction: column;
      align-items: flex-start;
    }
    .logo h1 {
      font-size: 24px;
      color: #ff6200;
      margin: 0;
    }
    .logo p {
      font-size: 12px;
      color: #ff6200;
      margin: 0;
    }
    .user-section {
      position: absolute;
      top: 15px;
      right: 15px;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .user-greeting {
      color: #ff6200;
      font-size: 14px;
      font-weight: bold;
    }
    .user-photo {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      overflow: hidden;
    }
    .user-photo img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    .balance {
      font-size: 16px;
      margin: 10px 0;
      background: #ffffff;
      padding: 8px;
      border-radius: 6px;
      width: 100%;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .balance-coins {
      display: flex;
      align-items: center;
      gap: 5px;
    }
    .coin-icon {
      width: 20px;
      height: 20px;
    }
    .buy-btn {
      background: #ff6200;
      color: #ffffff;
      border: none;
      padding: 8px 16px;
      border-radius: 5px;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 0 15px rgba(255, 98, 0, 0.5);
    }
    .buy-btn:hover {
      background: #e05600;
      transform: scale(1.1);
    }
    .predictions {
      width: 100%;
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 10px;
      flex: 1;
    }
    .prediction {
      background: #ffffff;
      padding: 10px;
      border-radius: 10px;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
      font-weight: bold;
      height: 150px;
      position: relative;
    }
    .prediction.locked {
      opacity: 0.7;
      cursor: pointer;
    }
    .prediction.unlocked {
      opacity: 1;
    }
    .tournament {
      font-size: 12px;
      text-align: center;
    }
    .teams {
      display: flex;
      flex-direction: column;
    }
    .team-row {
      display: flex;
      align-items: center;
      margin-bottom: 5px;
    }
    .team-row img {
      width: 30px;
      height: 30px;
      margin-right: 8px;
      border-radius: 50%;
    }
    .odds {
      font-size: 16px;
      padding: 4px 8px;
      background: #ff6200;
      color: #ffffff;
      border-radius: 5px;
      position: absolute;
      right: 10px;
      top: 50%;
      transform: translateY(-50%);
    }
    .buy-btn.unlock-btn {
      position: absolute;
      bottom: 10px;
      left: 50%;
      transform: translateX(-50%);
      padding: 4px 8px;
      font-size: 12px;
      display: none;
    }
    .prediction.locked .buy-btn.unlock-btn {
      display: block;
    }
    .prediction-text {
      font-size: 12px;
      text-align: center;
      margin-top: 5px;
      display: none;
    }
    .prediction.unlocked .prediction-text {
      display: block;
    }
  </style>
</head>
<body>
  <div class="header">
    <div class="logo">
      <h1>AiWinLab</h1>
      <p>Умные ставки. Большие выигрыши.</p>
    </div>
    <div class="user-section">
      <span class="user-greeting">Привет, <span id="userName">Гость</span></span>
      <div class="user-photo">
        <img id="userProfilePic" src="https://dummyimage.com/50x50/000000/ffffff?text=User" alt="Фото пользователя">
      </div>
    </div>
  </div>

  <div class="balance">
    <span class="balance-coins">
      <img src="https://cdn-icons-png.flaticon.com/128/2682/2682893.png" class="coin-icon" />
      <span id="coinBalance">0</span>
    </span>
    <button class="buy-btn" onclick="window.location.href='/buy-coins.html'">Купить монеты</button>
  </div>

  <div class="predictions" id="predictions"></div>

  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script>
    const telegram = window.Telegram?.WebApp;
    const predictionsContainer = document.getElementById("predictions");
    const coinBalance = document.getElementById("coinBalance");
    const userName = document.getElementById("userName");
    const userProfilePic = document.getElementById("userProfilePic");

    let predictions = [];
    let coins = parseInt(localStorage.getItem('coins')) || 0;
    let unlockedPredictions = JSON.parse(localStorage.getItem('unlockedPredictions')) || [];

    function initializeCoins() {
      if (!localStorage.getItem('visited')) {
        coins = 5;
        localStorage.setItem('coins', coins);
        localStorage.setItem('visited', 'true');
      }
    }

    function updateBalance() {
      coinBalance.textContent = coins;
    }

    function loadUserData() {
      if (telegram?.initDataUnsafe?.user) {
        const user = telegram.initDataUnsafe.user;
        userName.textContent = user.first_name || 'Гость';
        userProfilePic.src = user.photo_url || 'https://dummyimage.com/50x50/000000/ffffff?text=User';
      } else {
        userName.textContent = 'Гость (Тест)';
        userProfilePic.src = 'https://dummyimage.com/50x50/000000/ffffff?text=User';
      }
    }

    function renderPredictions() {
      updateBalance();
      predictionsContainer.innerHTML = '';
      if (predictions.length === 0) {
        predictionsContainer.innerHTML = '<p style="color: #ff6200;">Нет прогнозов для отображения.</p>';
        return;
      }

      predictions.forEach(p => {
        const div = document.createElement('div');
        div.className = `prediction ${p.isUnlocked ? 'unlocked' : 'locked'}`;
        div.innerHTML = `
          <div class="teams">
            <span class="tournament">${p.tournament || 'Турнир'}</span>
            <div class="team-row"><img src="${p.logo1}"> ${p.team1}</div>
            <div class="team-row"><img src="${p.logo2}"> ${p.team2}</div>
          </div>
          <span class="odds">${p.odds}</span>
          <div class="prediction-text">${p.predictionText}</div>
          <button class="buy-btn unlock-btn" onclick="unlockPrediction(${p.id})">Разблокировать</button>
        `;
        predictionsContainer.appendChild(div);
      });
    }

    async function loadPredictions() {
      const userId = telegram?.initDataUnsafe?.user?.id;
      if (!userId) return;

      try {
        const response = await fetch('/api/predictions');
        const data = await response.json();
        predictions = data.map(p => ({
          ...p,
          id: Number(p.id),
          isUnlocked: unlockedPredictions.includes(Number(p.id))
        }));

        const balanceResponse = await fetch('/balance', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ userId, action: 'get' })
        });
        const balance = await balanceResponse.json();
        coins = balance.coins || 0;
        localStorage.setItem('coins', coins);
        renderPredictions();
      } catch (error) {
        console.error('Ошибка загрузки:', error);
      }
    }

    function unlockPrediction(id) {
      if (coins < 1) {
        alert('Недостаточно монет!');
        return;
      }
      coins--;
      unlockedPredictions.push(id);
      localStorage.setItem('coins', coins);
      localStorage.setItem('unlockedPredictions', JSON.stringify(unlockedPredictions));
      const prediction = predictions.find(p => p.id === id);
      if (prediction) prediction.isUnlocked = true;
      renderPredictions();
    }

    // Инициализация
    initializeCoins();
    if (telegram) {
      telegram.ready();
      telegram.expand();
    }
    loadUserData();
    loadPredictions();
  </script>
</body>
</html>
