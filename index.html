<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AiWinLab - Прогнозы</title>
    <style>
        body {
            font-family: 'Verdana', sans-serif;
            margin: 0;
            padding: 0;
            background: #000000 url('https://www.transparenttextures.com/patterns/stardust.png');
            background-size: cover;
            color: #ff6200;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            overflow-x: hidden;
        }
        #userContainer {
            display: flex;
            align-items: center;
            margin-top: 20px;
            padding: 10px 20px;
            background: rgba(255, 98, 0, 0.1);
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(255, 98, 0, 0.3);
            animation: fadeIn 1s ease-in;
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        #userProfilePic {
            border-radius: 50%;
            width: 50px;
            height: 50px;
            border: 2px solid #ff6200;
            transition: transform 0.3s ease;
        }
        #userProfilePic:hover {
            transform: scale(1.1);
        }
        #userGreeting {
            margin-left: 10px;
            font-size: 20px;
            font-weight: bold;
            color: #ff6200;
        }
        #userName {
            margin-left: 5px;
            font-size: 20px;
            color: #ffffff;
            text-shadow: 0 0 5px #ff6200;
        }
        #coinBalance {
            font-size: 24px;
            margin: 20px 0;
            padding: 10px 20px;
            background: rgba(0, 0, 0, 0.7);
            border-radius: 5px;
            box-shadow: 0 0 10px rgba(255, 98, 0, 0.5);
        }
        #predictions {
            width: 90%;
            max-width: 800px;
            margin: 20px 0;
        }
        .prediction {
            background: rgba(0, 0, 0, 0.8);
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 5px;
            box-shadow: 0 0 10px rgba(255, 98, 0, 0.3);
            animation: slideUp 0.5s ease-out;
        }
        @keyframes slideUp {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        .prediction.locked .prediction-text {
            display: none;
        }
        .prediction.unlocked .prediction-text {
            display: block;
        }
        .teams {
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .team-row {
            display: flex;
            align-items: center;
            margin: 5px 0;
        }
        .team-row img {
            width: 30px;
            height: 30px;
            margin-right: 10px;
        }
        .tournament {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 10px;
        }
        .odds {
            font-size: 16px;
            color: #00ff00;
            margin: 10px 0;
            display: block;
        }
        .prediction-text {
            font-size: 14px;
            color: #ffffff;
            margin-top: 10px;
            text-align: center;
        }
        .buy-btn, .unlock-btn {
            background: #ff6200;
            color: #ffffff;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 0 10px rgba(255, 98, 0, 0.5);
        }
        .buy-btn:hover, .unlock-btn:hover {
            background: #e05600;
            transform: scale(1.05);
            box-shadow: 0 0 15px rgba(255, 98, 0, 0.7);
        }
        @media (max-width: 600px) {
            #userContainer {
                flex-direction: column;
                text-align: center;
            }
            #userGreeting, #userName {
                font-size: 16px;
                margin: 5px 0;
            }
            #userProfilePic {
                margin-bottom: 10px;
            }
            #coinBalance {
                font-size: 20px;
                padding: 8px 15px;
            }
            .prediction {
                padding: 10px;
            }
            .tournament {
                font-size: 16px;
            }
            .buy-btn, .unlock-btn {
                font-size: 14px;
                padding: 8px 15px;
            }
        }
    </style>
</head>
<body>
    <div id="userContainer">
        <img id="userProfilePic" src="https://dummyimage.com/50x50/000000/ffffff?text=User" alt="User Avatar">
        <span id="userGreeting">Привет </span><span id="userName">Гость</span>
    </div>
    <div id="coinBalance">0</div>
    <div id="predictions"></div>
    <button class="buy-btn" onclick="window.location.href='/buy-coins.html'">Купить монеты</button>

    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script>
        const telegram = window.Telegram?.WebApp;
        if (telegram) {
            telegram.ready(() => {
                telegram.expand();
                console.log('Telegram WebApp initialized and expanded');
            });
        } else {
            console.log('Telegram WebApp not available');
        }

        let predictions = [];
        async function loadPredictions() {
            try {
                let userId = telegram?.initDataUnsafe?.user?.id;
                if (!userId) {
                    console.warn('User ID not available, using default test ID');
                    userId = 'testUserId';
                }

                const predictionsResponse = await fetch('https://aiwinlab.onrender.com/api/predictions');
                if (!predictionsResponse.ok) {
                    throw new Error(`HTTP error! Status: ${predictionsResponse.status}`);
                }
                const serverPredictions = await predictionsResponse.json();
                predictions = Array.isArray(serverPredictions) ? serverPredictions.map(p => ({
                    ...p,
                    isUnlocked: unlockedPredictions.includes(p.id)
                })) : [];
                console.log('Predictions loaded:', predictions);

                const balanceResponse = await fetch('https://aiwinlab.onrender.com/balance', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ userId, action: 'get' })
                });
                if (!balanceResponse.ok) {
                    throw new Error(`HTTP error! Status: ${balanceResponse.status}`);
                }
                const balanceData = await balanceResponse.json();
                coins = balanceData.coins || 0;
                localStorage.setItem('coins', coins);
                updateBalance();
                renderPredictions();
            } catch (error) {
                console.error('Error loading predictions or balance:', error);
                predictions = [];
                renderPredictions();
                alert('Ошибка загрузки данных. Проверьте подключение или обратитесь к поддержке.');
            }
        }

        async function updatePredictions() {
            try {
                const response = await fetch('https://aiwinlab.onrender.com/api/predictions');
                if (!response.ok) {
                    throw new Error(`HTTP error! Status: ${response.status}`);
                }
                const serverPredictions = await response.json();
                predictions = Array.isArray(serverPredictions) ? serverPredictions.map(p => ({
                    ...p,
                    isUnlocked: unlockedPredictions.includes(p.id)
                })) : [];
                console.log('Updated predictions from server:', predictions);
                renderPredictions();
            } catch (error) {
                console.error('Error updating predictions:', error);
                predictions = [];
                renderPredictions();
            }
        }

        let coins = parseInt(localStorage.getItem('coins')) || 0;
        let unlockedPredictions = JSON.parse(localStorage.getItem('unlockedPredictions')) || [];

        function initializeCoins() {
            if (!localStorage.getItem('visited')) {
                coins = 5;
                localStorage.setItem('coins', coins);
                localStorage.setItem('visited', 'true');
            }
        }

        function updateBalance() {
            const coinBalance = document.getElementById('coinBalance');
            if (coinBalance) {
                coinBalance.textContent = coins;
            }
        }

        const coinBalance = document.getElementById('coinBalance');
        const predictionsContainer = document.getElementById('predictions');
        const userProfilePic = document.getElementById('userProfilePic');
        const userName = document.getElementById('userName');

        function loadUserData() {
            if (telegram) {
                const user = telegram.initDataUnsafe.user;
                if (user) {
                    if (user.first_name) {
                        userName.textContent = user.first_name;
                    } else {
                        userName.textContent = 'Гость';
                    }
                    if (user.photo_url) {
                        userProfilePic.src = user.photo_url;
                    } else {
                        userProfilePic.src = 'https://dummyimage.com/50x50/000000/ffffff?text=User';
                    }
                }
                telegram.ready();
                telegram.expand();
            } else {
                userName.textContent = 'Гость (Тест)';
                userProfilePic.src = 'https://dummyimage.com/50x50/000000/ffffff?text=User';
            }
        }

        function unlockPrediction(id, button) {
            if (coins < 1) {
                alert('Недостаточно монет! Купите ещё за Telegram Stars.');
                return;
            }
            coins--;
            unlockedPredictions.push(id);
            const prediction = predictions.find(p => p.id === id);
            if (prediction) prediction.isUnlocked = true;
            localStorage.setItem('coins', coins);
            localStorage.setItem('unlockedPredictions', JSON.stringify(unlockedPredictions));
            renderPredictions();
        }

        function renderPredictions() {
            const coinBalance = document.getElementById('coinBalance');
            if (coinBalance) coinBalance.textContent = coins;
            predictionsContainer.innerHTML = '';
            console.log('Rendering predictions with details:', JSON.stringify(predictions.map(p => ({
                id: p.id,
                tournament: p.tournament,
                team1: p.team1,
                logo1: p.logo1,
                team2: p.team2,
                logo2: p.logo2,
                odds: p.odds,
                predictionText: p.predictionText,
                isUnlocked: p.isUnlocked
            })), null, 2));
            if (predictions.length === 0) {
                predictionsContainer.innerHTML = '<p style="color: #ff6200;">Нет прогнозов для отображения.</p>';
                console.log('No predictions to render.');
            } else {
                predictions.forEach(p => {
                    const div = document.createElement('div');
                    div.className = `prediction ${p.isUnlocked ? 'unlocked' : 'locked'}`;
                    div.setAttribute('data-id', p.id);
                    div.innerHTML = `
                        <div class="teams">
                            <span class="tournament">${p.tournament || 'Нет турнира'}</span>
                            <div class="team-row"><img src="${p.logo1 || 'https://dummyimage.com/30x30/000000/ffffff'}" alt="${p.team1 || 'Команда 1'}"> ${p.team1 || 'Команда 1'}</div>
                            <div class="team-row"><img src="${p.logo2 || 'https://dummyimage.com/30x30/000000/ffffff'}" alt="${p.team2 || 'Команда 2'}"> ${p.team2 || 'Команда 2'}</div>
                        </div>
                        <span class="odds">${p.odds || '0.00'}</span>
                        <div class="prediction-text">${p.predictionText || 'Нет прогноза'}</div>
                        <button class="buy-btn unlock-btn" onclick="unlockPrediction(${p.id}, this)">Разблокировать</button>
                    `;
                    predictionsContainer.appendChild(div);
                });
            }
        }

        initializeCoins();
        loadUserData();
        loadPredictions();
        setInterval(updatePredictions, 5000);
    </script>
</body>
</html>