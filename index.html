<script src="https://telegram.org/js/telegram-web-app.js"></script>
<script>
    const telegram = window.Telegram?.WebApp;
    const userProfilePic = document.getElementById('userProfilePic');
    const userName = document.getElementById('userName');
    const predictionsContainer = document.getElementById('predictions');
    const coinBalance = document.getElementById('coinBalance');

    let predictions = [];
    let coins = parseInt(localStorage.getItem('coins')) || 0;
    let unlockedPredictions = JSON.parse(localStorage.getItem('unlockedPredictions')) || [];

    function initializeCoins() {
        if (!localStorage.getItem('visited')) {
            coins = 5;
            localStorage.setItem('coins', coins);
            localStorage.setItem('visited', 'true');
        }
    }

    function loadUserData() {
        try {
            if (telegram?.initDataUnsafe?.user) {
                const user = telegram.initDataUnsafe.user;
                userName.textContent = user.first_name || 'Гость';
                userProfilePic.src = user.photo_url || 'https://dummyimage.com/50x50/000000/ffffff?text=User';
            } else {
                userName.textContent = 'Гость (Тест)';
                userProfilePic.src = 'https://dummyimage.com/50x50/000000/ffffff?text=User';
            }
        } catch (error) {
            console.error('Ошибка получения данных пользователя:', error);
            userName.textContent = 'Гость';
            userProfilePic.src = 'https://dummyimage.com/50x50/000000/ffffff?text=User';
        }
    }

    async function loadPredictions() {
        const userId = telegram?.initDataUnsafe?.user?.id;
        if (!userId) {
            console.warn('User ID не найден');
            renderPredictions([]);
            return;
        }

        try {
            const predictionsResponse = await fetch('/api/predictions');
            const serverPredictions = await predictionsResponse.json();
            predictions = Array.isArray(serverPredictions)
                ? serverPredictions.map(p => ({
                    ...p,
                    id: Number(p.id),
                    isUnlocked: unlockedPredictions.map(Number).includes(Number(p.id))
                }))
                : [];

            const balanceResponse = await fetch('/balance', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ userId, action: 'get' })
            });

            const balanceData = await balanceResponse.json();
            coins = balanceData.coins || 0;
            localStorage.setItem('coins', coins);
            updateBalance();
            renderPredictions();
        } catch (error) {
            console.error('Ошибка загрузки данных:', error);
            predictions = [];
            renderPredictions();
        }
    }

    function updateBalance() {
        coinBalance.textContent = coins;
    }

    function unlockPrediction(id, button) {
        if (coins < 1) {
            alert('Недостаточно монет!');
            return;
        }
        coins--;
        unlockedPredictions.push(id);
        const prediction = predictions.find(p => Number(p.id) === Number(id));
        if (prediction) prediction.isUnlocked = true;
        localStorage.setItem('coins', coins);
        localStorage.setItem('unlockedPredictions', JSON.stringify(unlockedPredictions));
        renderPredictions();
    }

    function renderPredictions() {
        updateBalance();
        predictionsContainer.innerHTML = '';
        if (predictions.length === 0) {
            predictionsContainer.innerHTML = '<p style="color: #ff6200;">Нет прогнозов для отображения.</p>';
            return;
        }

        predictions.forEach(p => {
            const div = document.createElement('div');
            div.className = `prediction ${p.isUnlocked ? 'unlocked' : 'locked'}`;
            div.setAttribute('data-id', p.id);
            div.innerHTML = `
                <div class="teams">
                    <span class="tournament">${p.tournament || 'Нет турнира'}</span>
                    <div class="team-row"><img src="${p.logo1 || 'https://dummyimage.com/30x30'}" alt="${p.team1}"> ${p.team1 || 'Команда 1'}</div>
                    <div class="team-row"><img src="${p.logo2 || 'https://dummyimage.com/30x30'}" alt="${p.team2}"> ${p.team2 || 'Команда 2'}</div>
                </div>
                <span class="odds">${p.odds || '0.00'}</span>
                <div class="prediction-text">${p.predictionText || 'Нет прогноза'}</div>
                <button class="buy-btn unlock-btn" onclick="unlockPrediction(${p.id}, this)">Разблокировать</button>
            `;
            predictionsContainer.appendChild(div);
        });
    }

    // Запускаем всё после загрузки Telegram WebApp
    if (telegram) {
        telegram.ready(() => {
            telegram.expand();
            loadUserData();
            loadPredictions();
        });
    } else {
        // Для тестов в браузере
        loadUserData();
        loadPredictions();
    }

    initializeCoins();
    setInterval(loadPredictions, 5000);
</script>
